---
#
# Setup mysql server. 
#
- name: install mysql server packages
  yum: name={{ item }}  state=present
  with_items:
  - mysql-server

- name: set kernel shared memory max to a larger value
  sysctl: name=kernel.shmmax value={{ kernel_shmmax }}
  when: kernel_shmmax is defined
  notify:
  - restart mysql

- name: initialize mysql if necessary
  command: /usr/bin/postgresql-setup initdb
           creates=/var/lib/pgsql/data
  notify:
  - restart mysql

- name: set mysql server to run on boot
  service: name=mysql enabled=yes
  ignore_errors: true
  notify:
  - restart mysql

- name: mysql config template
  template: src=mysql.conf dest=/var/lib/pgsql/data/postgresql.conf
  notify:
  - restart mysql

- name: ensure mysql has a place to backup to
  file: dest=/backups state=directory owner=mysql

- name: copy over backup scriplet
  copy: src=backup-database dest=/usr/local/bin/backup-database mode=0755

- name: set up some cronjobs to backup databases as configured
  template: >
    src=cron-backup-database
    dest=/etc/cron.d/cron-backup-database-{{ item }}
  with_items:
  - "{{ dbs_to_backup }}"
  when: dbs_to_backup != []
