---
# Configuration for Mailman 2
# PostgreSQL initialization must have been done already

#
# Packages
#

- name: install needed packages
  yum: pkg={{ item }} state=present
  with_items:
  - mailman


#
# Initialize mailman (must be done after settings up the DBs)
#
#- name: add mailman to the apache group
#  user: name=mailman groups=apache append=yes
#  tags:
#  - config
#  #notify:
#  #  - restart mailman3

# access to the aliases files generated by mailman
- name: add postfix to the mailman group
  user: name=postfix groups=mailman append=yes
  tags:
  - config
  notify:
    - restart postfix

## for access to the full-text index
#- name: add apache to the mailman group
#  user: name=apache groups=mailman append=yes
#  tags:
#  - config
#  notify:
#    - restart httpd

- name: set the mailman conffile
  template: src={{ item }} dest=/etc/mailman.cfg
  with_first_found:
  - mailman.cfg.{{ ansible_hostname }}.j2
  - mailman.cfg.j2
  tags:
  - config
  notify:
    - restart mailman3


#
# Crontab
#
- name: set the crontab
  template: src=crontab.j2 dest=/etc/cron.d/hyperkitty
  tags:
  - config

#
# Logging
#
- name: hyperkitty logging -- directory
  file: path=/var/log/hyperkitty state=directory
        owner=root group=apache mode=2775
- name: hyperkitty logging -- file creation
  copy: content="" dest=/var/log/hyperkitty/hyperkitty.log
        force=no
- name: hyperkitty logging -- file permissions
  file: path=/var/log/hyperkitty/hyperkitty.log state=file
        owner=root group=apache mode=664
- name: hyperkitty logging -- rotation
  copy: src=hyperkitty.logrotate.conf
        dest=/etc/logrotate.d/hyperkitty

## Postfix
#- name: create the postfix aliases
#  command: su mailman -s /bin/sh -c "mailman3 aliases"
#           creates=/var/lib/mailman3/data/postfix_lmtp.db


# Start services
- name: start services
  service: state=started enabled=yes name={{ item }}
  with_items:
  - httpd
  - mailman
  - postfix
